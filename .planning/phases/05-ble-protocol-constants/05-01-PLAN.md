---
phase: 05-ble-protocol-constants
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/util/BleConstants.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt
autonomous: true

must_haves:
  truths:
    - "All UUIDs accessible via BleConstants.XXX"
    - "All timing constants centralized in single file"
    - "All threshold constants centralized in single file"
    - "Build compiles on both Android and iOS"
    - "No functional changes to BLE behavior"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/util/BleConstants.kt"
      provides: "Centralized BLE protocol constants"
      contains: "NUS_SERVICE_UUID"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt"
      provides: "Slim repository with external constant imports"
      min_lines: 2700
  key_links:
    - from: "KableBleRepository.kt"
      to: "BleConstants.kt"
      via: "import BleConstants"
      pattern: "import.*BleConstants"
---

<objective>
Extract all BLE protocol constants from KableBleRepository companion object to centralized BleConstants.kt.

Purpose: Single source of truth for all BLE UUIDs, timing, and thresholds - eliminates duplication between util/BleConstants.kt and KableBleRepository companion object.

Output: Unified BleConstants.kt with all ~35 constants from KableBleRepository companion object, plus updated KableBleRepository importing from central location.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ble-protocol-constants/05-RESEARCH.md

@shared/src/commonMain/kotlin/com/devil/phoenixproject/util/BleConstants.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend BleConstants.kt with all missing constants from KableBleRepository</name>
  <files>shared/src/commonMain/kotlin/com/devil/phoenixproject/util/BleConstants.kt</files>
  <action>
Add to BleConstants.kt all constants currently in KableBleRepository companion object (lines 62-147):

1. Add imports at top:
   ```kotlin
   import com.juul.kable.characteristicOf
   import kotlin.uuid.ExperimentalUuidApi
   import kotlin.uuid.Uuid
   ```

2. Add `@OptIn(ExperimentalUuidApi::class)` to object declaration

3. Add UUID vals (Uuid objects) after existing string constants:
   - `val NUS_SERVICE_UUID = Uuid.parse(NUS_SERVICE_UUID_STRING)`
   - `val NUS_TX_UUID = Uuid.parse(NUS_RX_CHAR_UUID_STRING)`  // Write to device (app TX = device RX, hence NUS_RX_CHAR_UUID_STRING for 6e400002)
   - `val NUS_RX_UUID = Uuid.parse("6e400003-b5a3-f393-e0a9-e50e24dcca9e")`  // Standard NUS RX (not used by Vitruvian)
   - `val MONITOR_UUID = Uuid.parse(SAMPLE_CHAR_UUID_STRING)`
   - `val REPS_UUID = Uuid.parse(REPS_CHAR_UUID_STRING)`
   - `val DIAGNOSTIC_UUID = Uuid.parse(DIAGNOSTIC_CHAR_UUID_STRING)`
   - `val HEURISTIC_UUID = Uuid.parse(HEURISTIC_CHAR_UUID_STRING)`
   - `val VERSION_UUID = Uuid.parse(VERSION_CHAR_UUID_STRING)`
   - `val MODE_UUID = Uuid.parse(MODE_CHAR_UUID_STRING)`
   - `val UPDATE_STATE_UUID = Uuid.parse(UPDATE_STATE_CHAR_UUID_STRING)`
   - `val BLE_UPDATE_REQUEST_UUID = Uuid.parse(BLE_UPDATE_REQUEST_CHAR_UUID_STRING)`
   - `val UNKNOWN_AUTH_UUID = Uuid.parse(UNKNOWN_AUTH_CHAR_UUID_STRING)`
   - `val DIS_SERVICE_UUID = Uuid.parse("0000180a-0000-1000-8000-00805f9b34fb")`
   - `val FIRMWARE_REVISION_UUID = Uuid.parse("00002a26-0000-1000-8000-00805f9b34fb")`

4. Add nested Timing object:
   ```kotlin
   object Timing {
       const val CONNECTION_RETRY_COUNT = 3
       const val CONNECTION_RETRY_DELAY_MS = 100L
       const val DESIRED_MTU = 247
       const val HEARTBEAT_INTERVAL_MS = 2000L
       const val HEARTBEAT_READ_TIMEOUT_MS = 1500L
       const val DELOAD_EVENT_DEBOUNCE_MS = 2000L
       const val DIAGNOSTIC_POLL_INTERVAL_MS = 500L
       const val HEURISTIC_POLL_INTERVAL_MS = 250L
       const val DIAGNOSTIC_LOG_EVERY = 20L
       const val STATE_TRANSITION_DWELL_MS = 200L
       const val WAITING_FOR_REST_TIMEOUT_MS = 3000L
       const val MAX_CONSECUTIVE_TIMEOUTS = 5
   }
   ```

5. Add nested Thresholds object:
   ```kotlin
   object Thresholds {
       const val HANDLE_GRABBED_THRESHOLD = 8.0
       const val HANDLE_REST_THRESHOLD = 5.0
       const val VELOCITY_THRESHOLD = 50.0
       const val AUTO_START_VELOCITY_THRESHOLD = 20.0
       const val VELOCITY_SMOOTHING_ALPHA = 0.3
       const val POSITION_SPIKE_THRESHOLD = 50000
       const val MIN_POSITION = -1000
       const val MAX_POSITION = 1000
       const val POSITION_JUMP_THRESHOLD = 20.0f
       const val MAX_WEIGHT_KG = 220.0f
       const val GRAB_DELTA_THRESHOLD = 10.0
       const val RELEASE_DELTA_THRESHOLD = 5.0
   }
   ```

6. Add HEARTBEAT_NO_OP:
   ```kotlin
   val HEARTBEAT_NO_OP = byteArrayOf(0x00, 0x00, 0x00, 0x00)
   ```

7. Add pre-built characteristic references at end:
   ```kotlin
   // Pre-built Kable characteristic references
   val txCharacteristic = characteristicOf(service = NUS_SERVICE_UUID, characteristic = NUS_TX_UUID)
   val rxCharacteristic = characteristicOf(service = NUS_SERVICE_UUID, characteristic = NUS_RX_UUID)
   val monitorCharacteristic = characteristicOf(service = NUS_SERVICE_UUID, characteristic = MONITOR_UUID)
   val repsCharacteristic = characteristicOf(service = NUS_SERVICE_UUID, characteristic = REPS_UUID)
   val diagnosticCharacteristic = characteristicOf(service = NUS_SERVICE_UUID, characteristic = DIAGNOSTIC_UUID)
   val heuristicCharacteristic = characteristicOf(service = NUS_SERVICE_UUID, characteristic = HEURISTIC_UUID)
   val versionCharacteristic = characteristicOf(service = NUS_SERVICE_UUID, characteristic = VERSION_UUID)
   val modeCharacteristic = characteristicOf(service = NUS_SERVICE_UUID, characteristic = MODE_UUID)
   val firmwareRevisionCharacteristic = characteristicOf(service = DIS_SERVICE_UUID, characteristic = FIRMWARE_REVISION_UUID)
   ```

Preserve all existing constants (don't delete anything) and maintain the existing structure.
  </action>
  <verify>File compiles: Check no syntax errors by reading the file</verify>
  <done>BleConstants.kt contains all 14 UUID vals, Timing object with 12 constants, Thresholds object with 12 constants, HEARTBEAT_NO_OP, and 9 characteristic references</done>
</task>

<task type="auto">
  <name>Task 2: Update KableBleRepository to import from BleConstants</name>
  <files>shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt</files>
  <action>
1. Add import at top of file:
   ```kotlin
   import com.devil.phoenixproject.util.BleConstants
   ```

2. In companion object (lines 62-147), REMOVE all constants that now exist in BleConstants:
   - Remove all UUID vals (NUS_SERVICE_UUID, NUS_TX_UUID, etc.)
   - Remove CONNECTION_RETRY_COUNT, CONNECTION_RETRY_DELAY_MS, DESIRED_MTU
   - Remove CONNECTION_TIMEOUT_MS (duplicate of BleConstants.CONNECTION_TIMEOUT_MS with same value 15000L)
   - Remove all threshold constants (HANDLE_GRABBED_THRESHOLD, etc.)
   - Remove all timing constants (HEARTBEAT_INTERVAL_MS, etc.)
   - Remove HEARTBEAT_NO_OP

3. Keep companion object for any state/instance-related constants that don't belong in protocol constants (if any). If empty after removal, remove the entire companion object block.

4. Locate the private val characteristic fields in the class body (after companion object, around lines 149-170). Replace their initialization with references to BleConstants:
   ```kotlin
   private val txCharacteristic = BleConstants.txCharacteristic
   private val rxCharacteristic = BleConstants.rxCharacteristic
   private val monitorCharacteristic = BleConstants.monitorCharacteristic
   private val repsCharacteristic = BleConstants.repsCharacteristic
   private val diagnosticCharacteristic = BleConstants.diagnosticCharacteristic
   private val heuristicCharacteristic = BleConstants.heuristicCharacteristic
   private val versionCharacteristic = BleConstants.versionCharacteristic
   private val modeCharacteristic = BleConstants.modeCharacteristic
   private val firmwareRevisionCharacteristic = BleConstants.firmwareRevisionCharacteristic
   ```

5. Update all usages of constants in the file body:
   - `CONNECTION_RETRY_COUNT` -> `BleConstants.Timing.CONNECTION_RETRY_COUNT`
   - `CONNECTION_RETRY_DELAY_MS` -> `BleConstants.Timing.CONNECTION_RETRY_DELAY_MS`
   - `CONNECTION_TIMEOUT_MS` -> `BleConstants.CONNECTION_TIMEOUT_MS` (root level)
   - `DESIRED_MTU` -> `BleConstants.Timing.DESIRED_MTU`
   - `HEARTBEAT_INTERVAL_MS` -> `BleConstants.Timing.HEARTBEAT_INTERVAL_MS`
   - `HEARTBEAT_READ_TIMEOUT_MS` -> `BleConstants.Timing.HEARTBEAT_READ_TIMEOUT_MS`
   - `DIAGNOSTIC_POLL_INTERVAL_MS` -> `BleConstants.Timing.DIAGNOSTIC_POLL_INTERVAL_MS`
   - `HEURISTIC_POLL_INTERVAL_MS` -> `BleConstants.Timing.HEURISTIC_POLL_INTERVAL_MS`
   - `DIAGNOSTIC_LOG_EVERY` -> `BleConstants.Timing.DIAGNOSTIC_LOG_EVERY`
   - `STATE_TRANSITION_DWELL_MS` -> `BleConstants.Timing.STATE_TRANSITION_DWELL_MS`
   - `WAITING_FOR_REST_TIMEOUT_MS` -> `BleConstants.Timing.WAITING_FOR_REST_TIMEOUT_MS`
   - `MAX_CONSECUTIVE_TIMEOUTS` -> `BleConstants.Timing.MAX_CONSECUTIVE_TIMEOUTS`
   - `DELOAD_EVENT_DEBOUNCE_MS` -> `BleConstants.Timing.DELOAD_EVENT_DEBOUNCE_MS`
   - `HANDLE_GRABBED_THRESHOLD` -> `BleConstants.Thresholds.HANDLE_GRABBED_THRESHOLD`
   - `HANDLE_REST_THRESHOLD` -> `BleConstants.Thresholds.HANDLE_REST_THRESHOLD`
   - `VELOCITY_THRESHOLD` -> `BleConstants.Thresholds.VELOCITY_THRESHOLD`
   - `AUTO_START_VELOCITY_THRESHOLD` -> `BleConstants.Thresholds.AUTO_START_VELOCITY_THRESHOLD`
   - `VELOCITY_SMOOTHING_ALPHA` -> `BleConstants.Thresholds.VELOCITY_SMOOTHING_ALPHA`
   - `MIN_POSITION` -> `BleConstants.Thresholds.MIN_POSITION`
   - `MAX_POSITION` -> `BleConstants.Thresholds.MAX_POSITION`
   - `POSITION_JUMP_THRESHOLD` -> `BleConstants.Thresholds.POSITION_JUMP_THRESHOLD`
   - `MAX_WEIGHT_KG` -> `BleConstants.Thresholds.MAX_WEIGHT_KG`
   - `GRAB_DELTA_THRESHOLD` -> `BleConstants.Thresholds.GRAB_DELTA_THRESHOLD`
   - `RELEASE_DELTA_THRESHOLD` -> `BleConstants.Thresholds.RELEASE_DELTA_THRESHOLD`
   - `HEARTBEAT_NO_OP` -> `BleConstants.HEARTBEAT_NO_OP`

6. Also check for any hardcoded UUID strings in logging/filtering and replace with constants:
   - Line 451 (or similar): `"6e400001-b5a3-f393-e0a9-e50e24dcca9e"` -> `BleConstants.NUS_SERVICE_UUID_STRING`
  </action>
  <verify>File compiles: Check no syntax errors, no unresolved references</verify>
  <done>KableBleRepository companion object reduced from ~85 lines to minimal (or empty), all constant references point to BleConstants</done>
</task>

<task type="auto">
  <name>Task 3: Verify build compiles on Android and iOS</name>
  <files></files>
  <action>
Run build verification:

1. Android build:
   ```bash
   ./gradlew :androidApp:assembleDebug --no-daemon
   ```

2. Check for compilation errors in output.

3. If on macOS, also verify iOS framework builds:
   ```bash
   ./gradlew :shared:assembleXCFramework --no-daemon
   ```

4. If build fails, fix any issues:
   - Missing imports
   - Unresolved references (constants not migrated correctly)
   - ExperimentalUuidApi opt-in issues (add @OptIn at file level)

Build must succeed with no new errors or warnings related to BleConstants.
  </action>
  <verify>./gradlew :androidApp:assembleDebug --no-daemon exits with BUILD SUCCESSFUL</verify>
  <done>Both Android and iOS (if applicable) targets compile successfully with no BleConstants-related errors</done>
</task>

</tasks>

<verification>
Phase 5 verification:
1. All UUIDs from KableBleRepository companion object now in BleConstants.kt
2. All timing constants from KableBleRepository companion object now in BleConstants.Timing
3. All threshold constants from KableBleRepository companion object now in BleConstants.Thresholds
4. KableBleRepository imports from BleConstants, no duplicate definitions
5. Build passes on Android (and iOS if on macOS)
6. No functional changes - just reorganization
</verification>

<success_criteria>
- BleConstants.kt contains all ~35 constants previously in KableBleRepository companion object
- KableBleRepository companion object reduced to empty or minimal
- Build compiles successfully on both platforms
- Requirement CONST-01 satisfied: "All BLE UUIDs and timing constants extracted to BleProtocolConstants.kt"
</success_criteria>

<output>
After completion, create `.planning/phases/05-ble-protocol-constants/05-01-SUMMARY.md`
</output>
