---
phase: 08-disco-mode-interface
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/DiscoMode.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/BleRepository.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/SettingsManager.kt
  - shared/src/commonTest/kotlin/com/devil/phoenixproject/testutil/FakeBleRepository.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/simulator/SimulatorBleRepository.kt
autonomous: true

must_haves:
  truths:
    - "DiscoMode.start() cycles LED colors via callback"
    - "DiscoMode.stop() restores lastColorSchemeIndex"
    - "setLastColorSchemeIndex() callable on BleRepository interface"
    - "SettingsManager uses interface method (no concrete cast)"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/DiscoMode.kt"
      provides: "Self-contained disco mode easter egg"
      exports: ["DiscoMode", "start", "stop", "setLastColorSchemeIndex", "isActive"]
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/BleRepository.kt"
      provides: "Interface with setLastColorSchemeIndex"
      contains: "fun setLastColorSchemeIndex"
  key_links:
    - from: "DiscoMode.kt"
      to: "KableBleRepository.kt"
      via: "sendCommand callback"
      pattern: "sendWorkoutCommand"
    - from: "SettingsManager.kt"
      to: "BleRepository.kt"
      via: "interface method call"
      pattern: "bleRepository.setLastColorSchemeIndex"
---

<objective>
Extract disco mode easter egg from KableBleRepository into self-contained DiscoMode.kt module and add setLastColorSchemeIndex() to BleRepository interface to eliminate concrete cast in SettingsManager (Issue #144).

Purpose: Improve testability and maintainability by isolating disco mode logic, fix dependency inversion violation
Output: DiscoMode.kt module, updated interface, Issue #144 fixed
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-disco-mode-interface/08-RESEARCH.md

@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/BleRepository.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/SettingsManager.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DiscoMode.kt with callback-based design</name>
  <files>shared/src/commonMain/kotlin/com/devil/phoenixproject/data/ble/DiscoMode.kt</files>
  <action>
Create DiscoMode.kt in data/ble/ following the callback-based extraction pattern from 08-RESEARCH.md:

```kotlin
package com.devil.phoenixproject.data.ble

import co.touchlab.kermit.Logger
import com.devil.phoenixproject.util.BlePacketFactory
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Job
import kotlinx.coroutines.delay
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.isActive
import kotlinx.coroutines.launch

/**
 * Disco Mode easter egg - rapidly cycles LED colors on the Vitruvian machine.
 *
 * Self-contained module extracted from KableBleRepository (Phase 8).
 * Uses callback for command sending to avoid circular dependency.
 *
 * @param scope Coroutine scope for launching the color cycling job
 * @param sendCommand Callback to send BLE commands (typically KableBleRepository::sendWorkoutCommand)
 */
class DiscoMode(
    private val scope: CoroutineScope,
    private val sendCommand: suspend (ByteArray) -> Unit
) {
    private val log = Logger.withTag("DiscoMode")

    private var discoJob: Job? = null
    private var lastColorSchemeIndex: Int = 0

    private val _isActive = MutableStateFlow(false)
    val isActive: StateFlow<Boolean> = _isActive.asStateFlow()

    /**
     * Start disco mode - rapidly cycles through LED color schemes.
     * No-op if already running.
     */
    fun start() {
        if (discoJob?.isActive == true) {
            log.d { "Disco mode already active" }
            return
        }

        log.i { "Starting DISCO MODE!" }
        _isActive.value = true

        discoJob = scope.launch {
            var colorIndex = 0
            val colorCount = 7  // Schemes 0-6 (excluding "None" at 7)
            val intervalMs = 300L

            while (isActive) {
                try {
                    val command = BlePacketFactory.createColorSchemeCommand(colorIndex)
                    sendCommand(command)
                    colorIndex = (colorIndex + 1) % colorCount
                    delay(intervalMs)
                } catch (e: Exception) {
                    log.w { "Disco mode error: ${e.message}" }
                    break
                }
            }
            log.d { "Disco mode coroutine ended" }
        }
    }

    /**
     * Stop disco mode and restore the last selected color scheme.
     */
    fun stop() {
        if (discoJob?.isActive != true && !_isActive.value) {
            return
        }

        log.i { "Stopping disco mode, restoring color scheme $lastColorSchemeIndex" }
        discoJob?.cancel()
        discoJob = null
        _isActive.value = false

        // Restore the user's color scheme
        scope.launch {
            try {
                val command = BlePacketFactory.createColorSchemeCommand(lastColorSchemeIndex)
                sendCommand(command)
            } catch (e: Exception) {
                log.w { "Failed to restore color scheme: ${e.message}" }
            }
        }
    }

    /**
     * Update the stored color scheme index.
     * Called when user changes color in settings.
     */
    fun setLastColorSchemeIndex(index: Int) {
        lastColorSchemeIndex = index
    }
}
```

Key design decisions per research:
- Callback `suspend (ByteArray) -> Unit` avoids circular dependency with KableBleRepository
- Class (not object) per 07-01 decision for future multi-device support
- _isActive MutableStateFlow exposed as read-only StateFlow
  </action>
  <verify>`./gradlew :shared:compileKotlinAndroid` compiles without errors. DiscoMode.kt exists in data/ble/ directory.</verify>
  <done>DiscoMode.kt created with start(), stop(), setLastColorSchemeIndex(), and isActive StateFlow. Build compiles.</done>
</task>

<task type="auto">
  <name>Task 2: Add setLastColorSchemeIndex to interface and update implementations</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/BleRepository.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/KableBleRepository.kt
    shared/src/commonTest/kotlin/com/devil/phoenixproject/testutil/FakeBleRepository.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/data/repository/simulator/SimulatorBleRepository.kt
  </files>
  <action>
**Step 1: Add interface method to BleRepository.kt**

After the `stopDiscoMode()` declaration (around line 261), add:

```kotlin
    /**
     * Update the color scheme index for disco mode restore.
     * Phase 8: Added to interface to eliminate concrete cast in SettingsManager (Issue #144).
     * Default no-op for implementations that don't need it.
     */
    fun setLastColorSchemeIndex(index: Int) {
        // No-op default - only KableBleRepository needs this
    }
```

**Step 2: Update KableBleRepository.kt to use DiscoMode**

Near the top (around line 163), replace:
```kotlin
private var discoJob: kotlinx.coroutines.Job? = null
private var lastColorSchemeIndex: Int = 0  // To restore after disco mode
```

With:
```kotlin
private val discoMode = DiscoMode(
    scope = scope,
    sendCommand = { command -> sendWorkoutCommand(command) }
)
```

Update the state flow delegation (around line 145-146):
```kotlin
// OLD:
private val _discoModeActive = MutableStateFlow(false)
override val discoModeActive: StateFlow<Boolean> = _discoModeActive.asStateFlow()

// NEW:
override val discoModeActive: StateFlow<Boolean> = discoMode.isActive
```

Remove the entire disco mode section (lines 2393-2468) and replace with delegation:
```kotlin
// ========== Disco Mode (Easter Egg) ==========

override fun startDiscoMode() {
    if (peripheral == null) {
        log.w { "Cannot start disco mode - not connected" }
        return
    }
    discoMode.start()
}

override fun stopDiscoMode() = discoMode.stop()

override fun setLastColorSchemeIndex(index: Int) = discoMode.setLastColorSchemeIndex(index)
```

Also call `discoMode.stop()` in the two places where `stopDiscoMode()` was previously called inline (disconnect handling around lines 1166 and 1422).

Add import at top of file:
```kotlin
import com.devil.phoenixproject.data.ble.DiscoMode
```

**Step 3: Update FakeBleRepository.kt**

Add the interface method implementation after `stopDiscoMode()`:
```kotlin
override fun setLastColorSchemeIndex(index: Int) {
    // No-op in fake - no color tracking needed
}
```

**Step 4: Update SimulatorBleRepository.kt**

Add the interface method implementation after `stopDiscoMode()`:
```kotlin
override fun setLastColorSchemeIndex(index: Int) {
    // No-op in simulator - no physical LEDs
}
```
  </action>
  <verify>`./gradlew :shared:compileKotlinAndroid` compiles. Grep for `as? KableBleRepository` returns 0 matches in SettingsManager (checked in Task 3). Verify `discoModeActive` still exposed via interface.</verify>
  <done>BleRepository interface has setLastColorSchemeIndex(). All 3 implementations (Kable, Fake, Simulator) implement it. KableBleRepository delegates to DiscoMode instance.</done>
</task>

<task type="auto">
  <name>Task 3: Fix SettingsManager concrete cast (Issue #144)</name>
  <files>shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/SettingsManager.kt</files>
  <action>
In SettingsManager.kt, update the `setColorScheme` method (around lines 77-84):

**FROM:**
```kotlin
fun setColorScheme(schemeIndex: Int) {
    scope.launch {
        bleRepository.setColorScheme(schemeIndex)
        preferencesManager.setColorScheme(schemeIndex)
        // Update disco mode's restore color index
        (bleRepository as? KableBleRepository)?.setLastColorSchemeIndex(schemeIndex)
    }
}
```

**TO:**
```kotlin
fun setColorScheme(schemeIndex: Int) {
    scope.launch {
        bleRepository.setColorScheme(schemeIndex)
        preferencesManager.setColorScheme(schemeIndex)
        // Update disco mode's restore color index (Issue #144: via interface method)
        bleRepository.setLastColorSchemeIndex(schemeIndex)
    }
}
```

Also REMOVE the import that is now unused:
```kotlin
// REMOVE this line:
import com.devil.phoenixproject.data.repository.KableBleRepository
```
  </action>
  <verify>
1. `grep -c "as? KableBleRepository" shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/SettingsManager.kt` returns 0
2. `grep -c "import.*KableBleRepository" shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/SettingsManager.kt` returns 0
3. `./gradlew :shared:compileKotlinAndroid` compiles
  </verify>
  <done>SettingsManager calls bleRepository.setLastColorSchemeIndex() via interface. No concrete cast. No KableBleRepository import. Issue #144 fixed.</done>
</task>

</tasks>

<verification>
1. Build verification:
   - `./gradlew :shared:compileKotlinAndroid` passes
   - `./gradlew :androidApp:assembleDebug` passes

2. Extraction verification:
   - DiscoMode.kt exists in data/ble/ with ~90 lines
   - KableBleRepository delegates disco operations to DiscoMode instance
   - `discoJob` and `lastColorSchemeIndex` removed from KableBleRepository

3. Interface verification:
   - `setLastColorSchemeIndex(index: Int)` declared in BleRepository interface
   - All 3 implementations have the method

4. Issue #144 verification:
   - `grep -r "as? KableBleRepository" shared/src/commonMain/` returns 0 matches
   - SettingsManager has no KableBleRepository import
</verification>

<success_criteria>
- DiscoMode.kt created and compiles
- BleRepository interface includes setLastColorSchemeIndex()
- KableBleRepository delegates to DiscoMode instance
- SettingsManager uses interface method (no cast)
- All builds pass
- No `as? KableBleRepository` casts remain in codebase
</success_criteria>

<output>
After completion, create `.planning/phases/08-disco-mode-interface/08-01-SUMMARY.md`
</output>
