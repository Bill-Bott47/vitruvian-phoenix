---
phase: 02-manager-decomposition
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/WorkoutCoordinator.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/DefaultWorkoutSessionManager.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/BleConnectionManager.kt
  - shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/viewmodel/MainViewModel.kt
  - shared/src/commonTest/kotlin/com/devil/phoenixproject/testutil/DWSMTestHarness.kt
autonomous: true
must_haves:
  truths:
    - "DWSM no longer has `lateinit var bleConnectionManager` — the circular dependency is eliminated"
    - "BLE connection errors flow from DWSM/ActiveSessionEngine to BleConnectionManager via SharedFlow, not direct reference"
    - "MainViewModel no longer needs the two-step construction (create DWSM, then set bleConnectionManager)"
    - "All 38 characterization tests pass after the change"
  artifacts:
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/WorkoutCoordinator.kt"
      provides: "bleErrorEvents SharedFlow"
      contains: "bleErrorEvents"
    - path: "shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/BleConnectionManager.kt"
      provides: "BleConnectionManager collecting from bleErrorEvents"
      contains: "bleErrorEvents.collect"
  key_links:
    - from: "DefaultWorkoutSessionManager.kt"
      to: "WorkoutCoordinator.kt"
      via: "coordinator.bleErrorEvents.emit()"
      pattern: "bleErrorEvents.emit"
    - from: "BleConnectionManager.kt"
      to: "WorkoutCoordinator.kt"
      via: "bleErrorEvents collection in init"
      pattern: "bleErrorEvents"
---

<objective>
Eliminate the circular dependency between BleConnectionManager and DefaultWorkoutSessionManager by replacing the `lateinit var bleConnectionManager` with a SharedFlow-based error event pattern on WorkoutCoordinator.

Purpose: The `lateinit var` is the only circular dependency between DWSM and BleConnectionManager. Removing it now (while DWSM is still monolithic) is simpler than doing it during ActiveSessionEngine extraction, and it simplifies the MainViewModel construction sequence.

Output: No more `lateinit var`, BleConnectionManager receives `bleErrorEvents: SharedFlow<String>` instead of `WorkoutStateProvider`, MainViewModel construction simplified, all 38 tests passing.
</objective>

<execution_context>
@C:/Users/dasbl/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/dasbl/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-manager-decomposition/02-RESEARCH.md
@.planning/phases/02-manager-decomposition/02-01-SUMMARY.md
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/DefaultWorkoutSessionManager.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/BleConnectionManager.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/viewmodel/MainViewModel.kt
@shared/src/commonTest/kotlin/com/devil/phoenixproject/testutil/DWSMTestHarness.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace lateinit var with SharedFlow bleErrorEvents</name>
  <files>
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/WorkoutCoordinator.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/DefaultWorkoutSessionManager.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/BleConnectionManager.kt
    shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/viewmodel/MainViewModel.kt
    shared/src/commonTest/kotlin/com/devil/phoenixproject/testutil/DWSMTestHarness.kt
  </files>
  <action>
**CRITICAL: This plan has 2 usage sites and a clean replacement pattern. Test after each step.**

**Step 1: Add bleErrorEvents to WorkoutCoordinator.**

Add to WorkoutCoordinator:
```kotlin
val bleErrorEvents = MutableSharedFlow<String>(
    extraBufferCapacity = 5,
    onBufferOverflow = kotlinx.coroutines.channels.BufferOverflow.DROP_OLDEST
)
```

Commit: `refactor(02-02): add bleErrorEvents SharedFlow to WorkoutCoordinator`

**Step 2: Update DWSM to emit errors instead of calling bleConnectionManager.**

Find the 2 usage sites of `bleConnectionManager` in DWSM (both in `startWorkout()` catch blocks, around lines 3176 and 3189):
```kotlin
// Before:
bleConnectionManager.setConnectionError("Failed to send command: ${e.message}")
// After:
coordinator.bleErrorEvents.tryEmit("Failed to send command: ${e.message}")
```

Replace both sites. Then REMOVE the `lateinit var bleConnectionManager: BleConnectionManager` declaration from DWSM.

Run tests. Commit: `refactor(02-02): replace bleConnectionManager lateinit with bleErrorEvents emission`

**Step 3: Update BleConnectionManager to collect from bleErrorEvents.**

Currently BleConnectionManager takes `workoutStateProvider: WorkoutStateProvider` in its constructor. It needs the `WorkoutStateProvider` interface for reading workout state (check what it actually uses). But it no longer needs the back-reference for error setting.

Add `bleErrorEvents: SharedFlow<String>` to BleConnectionManager's constructor. In BleConnectionManager's init block (or a launched coroutine), collect from it:
```kotlin
scope.launch {
    bleErrorEvents.collect { message ->
        _connectionError.value = message
    }
}
```

IMPORTANT: Read BleConnectionManager.kt carefully first. It may use `workoutStateProvider` for OTHER things besides the circular dep. The `WorkoutStateProvider` interface (defined in BleConnectionManager.kt lines 23+) may still be needed for reading workout state — only the BACK-reference (DWSM -> BleConnectionManager) is being removed.

Commit: `refactor(02-02): BleConnectionManager collects bleErrorEvents from coordinator`

**Step 4: Update MainViewModel construction.**

Find where MainViewModel constructs BleConnectionManager and wires it to DWSM. Remove the `.also { it.bleConnectionManager = ... }` pattern. Pass `coordinator.bleErrorEvents` (or `dwsm.coordinator.bleErrorEvents`) to BleConnectionManager's constructor instead.

The construction order should now be:
1. Create DWSM (which internally creates coordinator)
2. Create BleConnectionManager with `dwsm.coordinator.bleErrorEvents` — no back-reference needed
3. No `.also` step needed

Commit: `refactor(02-02): simplify MainViewModel DWSM/BLE construction`

**Step 5: Update DWSMTestHarness.**

Remove the `.also { it.bleConnectionManager = ... }` block. Construct BleConnectionManager with `dwsm.coordinator.bleErrorEvents` (as a SharedFlow). Wire appropriately.

Run full test suite. Commit: `refactor(02-02): update test harness for bleErrorEvents pattern`

**IMPORTANT CONSTRAINTS:**
- The `WorkoutStateProvider` interface may still be needed by BleConnectionManager for reading state — do NOT remove it unless analysis shows it's unused
- BLE error flow direction: ActiveSessionEngine/DWSM EMITS, BleConnectionManager COLLECTS (one-way)
- If tests fail at any step, revert immediately
  </action>
  <verify>
Run `./gradlew :shared:testDebugUnitTest` — all 38 tests pass.
Verify `lateinit var bleConnectionManager` no longer exists in DWSM: `grep -n "lateinit" DefaultWorkoutSessionManager.kt` returns nothing.
Verify BleConnectionManager collects from bleErrorEvents: `grep -n "bleErrorEvents" BleConnectionManager.kt` shows collection.
  </verify>
  <done>
`lateinit var bleConnectionManager` eliminated from DWSM. BLE errors flow via SharedFlow. MainViewModel construction is simplified (no two-step wiring). DWSMTestHarness updated. All 38 tests pass.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew :shared:testDebugUnitTest` — all 38 tests pass
2. `grep "lateinit" DefaultWorkoutSessionManager.kt` returns nothing
3. `grep "bleErrorEvents" WorkoutCoordinator.kt` shows SharedFlow declaration
4. `grep "bleErrorEvents" BleConnectionManager.kt` shows collection
5. MainViewModel.kt no longer has the `.also { it.bleConnectionManager = }` pattern
</verification>

<success_criteria>
- Circular dependency between BleConnectionManager and DWSM eliminated
- BLE errors transmitted via SharedFlow (one-way: DWSM -> BleConnectionManager)
- MainViewModel construction simplified
- All 38 Phase 1 characterization tests pass
- Atomic git commits per step
</success_criteria>

<output>
After completion, create `.planning/phases/02-manager-decomposition/02-02-SUMMARY.md`
</output>
