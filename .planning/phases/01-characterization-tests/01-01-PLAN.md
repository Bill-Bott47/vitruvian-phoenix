---
phase: 01-characterization-tests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/src/commonTest/kotlin/com/devil/phoenixproject/testutil/DWSMTestHarness.kt
  - shared/src/commonTest/kotlin/com/devil/phoenixproject/testutil/WorkoutStateFixtures.kt
  - shared/src/commonTest/kotlin/com/devil/phoenixproject/presentation/manager/DWSMWorkoutLifecycleTest.kt
autonomous: true

must_haves:
  truths:
    - "Running ./gradlew :shared:testDebugUnitTest executes workout lifecycle characterization tests that pass"
    - "DWSMTestHarness constructs DWSM with all 13+1 dependencies using fakes, inside a TestScope"
    - "WorkoutStateFixtures provide one-line factory methods to get DWSM into Active, Resting, and SetSummary states"
    - "Tests lock in startWorkout state transitions (Idle -> Initializing -> Countdown -> Active)"
    - "Tests lock in stopWorkout behavior (Active -> SetSummary or Idle depending on exitingWorkout flag)"
    - "Tests lock in auto-stop detection via position-based stall"
    - "Tests lock in saveWorkoutSession side effects (repo write, gamification processing)"
  artifacts:
    - path: "shared/src/commonTest/kotlin/com/devil/phoenixproject/testutil/DWSMTestHarness.kt"
      provides: "DWSM construction with all fakes wired"
      contains: "class DWSMTestHarness"
    - path: "shared/src/commonTest/kotlin/com/devil/phoenixproject/testutil/WorkoutStateFixtures.kt"
      provides: "Pre-built workout states for one-line test setup"
      contains: "object WorkoutStateFixtures"
    - path: "shared/src/commonTest/kotlin/com/devil/phoenixproject/presentation/manager/DWSMWorkoutLifecycleTest.kt"
      provides: "Characterization tests for workout lifecycle"
      contains: "class DWSMWorkoutLifecycleTest"
  key_links:
    - from: "DWSMTestHarness.kt"
      to: "DefaultWorkoutSessionManager"
      via: "constructor wiring with all 13 deps + lateinit bleConnectionManager"
      pattern: "DefaultWorkoutSessionManager\\("
    - from: "DWSMWorkoutLifecycleTest.kt"
      to: "DWSMTestHarness.kt"
      via: "harness construction in each test"
      pattern: "DWSMTestHarness\\(this\\)"
    - from: "WorkoutStateFixtures.kt"
      to: "DWSMTestHarness.kt"
      via: "fixture functions that construct and advance harness to target state"
      pattern: "DWSMTestHarness\\(this\\)"
---

<objective>
Build the DWSM test harness, workout state fixtures, and workout lifecycle characterization tests.

Purpose: Lock in the current workout lifecycle behavior (start, stop, countdown, auto-stop, save session) so Phase 2 extractions can safely refactor without regression.

Output: DWSMTestHarness.kt, WorkoutStateFixtures.kt, DWSMWorkoutLifecycleTest.kt -- all passing in commonTest.
</objective>

<execution_context>
@C:\Users\dasbl\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dasbl\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-characterization-tests/01-RESEARCH.md

@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/DefaultWorkoutSessionManager.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/SettingsManager.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/GamificationManager.kt
@shared/src/commonMain/kotlin/com/devil/phoenixproject/presentation/manager/BleConnectionManager.kt
@shared/src/commonTest/kotlin/com/devil/phoenixproject/testutil/TestFixtures.kt
@shared/src/commonTest/kotlin/com/devil/phoenixproject/testutil/FakeBleRepository.kt
@shared/src/commonTest/kotlin/com/devil/phoenixproject/testutil/FakeWorkoutRepository.kt
@shared/src/commonTest/kotlin/com/devil/phoenixproject/testutil/FakeExerciseRepository.kt
@shared/src/commonTest/kotlin/com/devil/phoenixproject/testutil/FakePersonalRecordRepository.kt
@shared/src/commonTest/kotlin/com/devil/phoenixproject/testutil/FakePreferencesManager.kt
@shared/src/commonTest/kotlin/com/devil/phoenixproject/testutil/FakeGamificationRepository.kt
@shared/src/commonTest/kotlin/com/devil/phoenixproject/testutil/FakeCompletedSetRepository.kt
@shared/src/commonTest/kotlin/com/devil/phoenixproject/testutil/FakeTrainingCycleRepository.kt
</context>

<tasks>

<task type="auto">
  <name>Task 1: DWSMTestHarness and WorkoutStateFixtures</name>
  <files>
    shared/src/commonTest/kotlin/com/devil/phoenixproject/testutil/DWSMTestHarness.kt
    shared/src/commonTest/kotlin/com/devil/phoenixproject/testutil/WorkoutStateFixtures.kt
  </files>
  <action>
Create DWSMTestHarness class in testutil/ that constructs a fully-wired DefaultWorkoutSessionManager inside a TestScope. Follow the exact pattern from 01-RESEARCH.md Pattern 1:

1. **DWSMTestHarness.kt**: Class taking `TestScope` as constructor parameter. Must:
   - Instantiate all 7 existing fake repositories (FakeBleRepository, FakeWorkoutRepository, FakeExerciseRepository, FakePersonalRecordRepository, FakeCompletedSetRepository, FakeTrainingCycleRepository, FakeGamificationRepository)
   - Instantiate FakePreferencesManager
   - Construct real RepCounterFromMachine (stateless, no-arg constructor)
   - Construct real ResolveRoutineWeightsUseCase with FakePersonalRecordRepository
   - Construct real SettingsManager with (FakePreferencesManager, FakeBleRepository, testScope). NOTE: SettingsManager imports KableBleRepository but only uses it via safe cast `as?` -- FakeBleRepository works fine since the cast returns null.
   - Construct real GamificationManager with (FakeGamificationRepository, FakePersonalRecordRepository, FakeExerciseRepository, MutableSharedFlow(extraBufferCapacity=10), testScope)
   - Construct DefaultWorkoutSessionManager with all deps, passing `syncTriggerManager = null` and `scope = testScope`
   - In `.also {}` block after construction, set `it.bleConnectionManager = BleConnectionManager(fakeBleRepo, settingsManager, it, testScope)` -- DWSM implements WorkoutStateProvider so `it` is valid for the third parameter
   - Expose all fakes as public `val` properties for test control
   - Expose the DWSM instance as `val dwsm`

2. **WorkoutStateFixtures.kt**: Object with extension functions on TestScope that return a DWSMTestHarness already advanced to a target state:
   - `activeDWSM()`: Constructs harness, calls `simulateConnect("Vee_Test")`, calls `startWorkout(skipCountdown = true)`, calls `advanceUntilIdle()`, returns harness. Assert workoutState is Active before returning.
   - `setReadyDWSM(routine: Routine? = null)`: Constructs harness, seeds exercises into FakeExerciseRepository, calls `loadRoutine()`, calls `advanceUntilIdle()`, calls `enterSetReady(0, 0)`, returns harness.
   - `createTestRoutine(exerciseCount, setsPerExercise, weightKg, repsPerSet)`: Factory matching the pattern in 01-RESEARCH.md Code Examples section.
   - `createSupersetRoutine()`: Factory matching the superset pattern in research.

**CRITICAL:** Read the actual constructor signatures of SettingsManager, GamificationManager, BleConnectionManager, and DefaultWorkoutSessionManager from their source files before writing. The research is high-confidence but verify parameter order and types.

**CRITICAL:** DWSM's init block launches coroutines. The harness MUST be constructed inside `runTest {}` so TestScope captures them. Document this in a KDoc comment on the class.
  </action>
  <verify>
Run `./gradlew :shared:testDebugUnitTest --tests "com.devil.phoenixproject.*"` -- should compile without errors. No test failures from existing tests. (The new files have no tests yet, just infrastructure.)
  </verify>
  <done>
DWSMTestHarness compiles and constructs DWSM with all 14 dependencies wired. WorkoutStateFixtures provides activeDWSM() and setReadyDWSM() factory methods. No compilation errors in commonTest.
  </done>
</task>

<task type="auto">
  <name>Task 2: Workout lifecycle characterization tests</name>
  <files>
    shared/src/commonTest/kotlin/com/devil/phoenixproject/presentation/manager/DWSMWorkoutLifecycleTest.kt
  </files>
  <action>
Create DWSMWorkoutLifecycleTest.kt with characterization tests that lock in current workout lifecycle behavior. These tests assert WHAT the code does today, not what it SHOULD do. If behavior is surprising, lock it in anyway and add a comment.

**Test categories (minimum tests per category):**

**A. startWorkout transitions (3-4 tests):**
- `startWorkout_setsStateToInitializingImmediately`: Call startWorkout(skipCountdown=true) on connected DWSM, assert workoutState.value == Initializing BEFORE advanceUntilIdle()
- `startWorkout_transitionsToActive_afterCountdownSkipped`: Same but with advanceUntilIdle(), assert Active
- `startWorkout_countdown_emitsCountdownStates`: Use Turbine `.test {}` on workoutState flow. Call startWorkout(skipCountdown=false). Use advanceTimeBy(1000) to step through countdown. Assert Initializing -> Countdown(5) -> ... -> Countdown(1) -> Active. See research Pattern 2 for exact Turbine pattern.
- `startWorkout_sendsBleStartCommand`: After startWorkout + advanceUntilIdle, assert fakeBleRepo.workoutParameters is not empty (BLE start was called)

**B. stopWorkout transitions (3-4 tests):**
- `stopWorkout_withExitingWorkout_transitionsToIdle`: Use activeDWSM fixture, call stopWorkout(exitingWorkout=true), advanceUntilIdle(), assert workoutState == Idle
- `stopWorkout_withoutExitingWorkout_transitionsToSetSummary`: Use activeDWSM fixture, call stopWorkout(exitingWorkout=false), advanceUntilIdle(), assert workoutState is SetSummary
- `stopWorkout_guardFlag_preventsDoubleStop`: Use activeDWSM, call stopWorkout twice rapidly, assert no crash and state is consistent
- `stopWorkout_sendsBleStopCommand`: After stopWorkout, verify BLE stop was called (check fakeBleRepo commands or method calls)

**C. resetForNewWorkout (1-2 tests):**
- `resetForNewWorkout_clearsState`: After activeDWSM + stopWorkout, call resetForNewWorkout, assert rep counter and metrics are cleared

**D. updateWorkoutParameters (1-2 tests):**
- `updateWorkoutParameters_updatesCurrentParams`: Use activeDWSM, call updateWorkoutParameters with new params, assert workoutParameters flow reflects the update

**E. auto-stop behavior (2-3 tests):**
- `autoStop_triggersAfterStallDuration`: Use activeDWSM fixture, emit metrics via fakeBleRepo that simulate handles at rest position for >2.5s. Use advanceTimeBy() to advance past AUTO_STOP_DURATION_SECONDS. Check if workoutState transitions away from Active.
- Note: checkAutoStop is private, so test indirectly through metric emission. If the auto-stop behavior proves too complex to trigger through fakes alone (the metric flow collection in init block may not be straightforward), document what you discovered and write a simpler test that at least verifies the metrics flow is being consumed.

**F. saveWorkoutSession side effects (1-2 tests):**
- `stopWorkout_savesSessionToRepository`: Use activeDWSM, stopWorkout(exitingWorkout=false), advanceUntilIdle(), check FakeWorkoutRepository has a saved session
- `stopWorkout_triggersGamificationProcessing`: After stopWorkout, verify gamification was invoked (check if FakeGamificationRepository was accessed or prCelebrationEvent was emitted)

**Pattern for all tests:**
```kotlin
@Test
fun testName() = runTest {
    val harness = DWSMTestHarness(this)  // or WorkoutStateFixtures.activeDWSM()
    // ... setup ...
    // ... action ...
    advanceUntilIdle()  // ALWAYS after async operations
    // ... assertions ...
}
```

**CRITICAL:** Use `advanceUntilIdle()` after any DWSM method that launches coroutines (startWorkout, stopWorkout, loadRoutine). Use `advanceTimeBy()` for countdown and delay-based logic.

**CRITICAL:** These are characterization tests. If a test reveals unexpected behavior, KEEP the assertion matching actual behavior and add a comment like: `// Characterization: DWSM does X here, possibly unexpected`

**CRITICAL:** Do NOT modify DefaultWorkoutSessionManager.kt or any production code. Zero changes to src/commonMain/.
  </action>
  <verify>
Run `./gradlew :shared:testDebugUnitTest --tests "com.devil.phoenixproject.presentation.manager.DWSMWorkoutLifecycleTest"` -- all tests pass. Then run `./gradlew :shared:testDebugUnitTest` to verify no existing tests broke.
  </verify>
  <done>
At least 12 characterization tests pass covering startWorkout transitions, stopWorkout transitions, resetForNewWorkout, updateWorkoutParameters, auto-stop behavior, and saveWorkoutSession side effects. All tests run in commonTest with no platform dependencies. All existing tests still pass.
  </done>
</task>

</tasks>

<verification>
1. `./gradlew :shared:testDebugUnitTest` -- ALL tests pass (new + existing)
2. DWSMWorkoutLifecycleTest has >= 12 passing tests
3. Zero modifications to any file under shared/src/commonMain/
4. DWSMTestHarness is reusable by Plan 01-02 (routine flow tests)
5. WorkoutStateFixtures.activeDWSM() produces a DWSM in Active state in one call
</verification>

<success_criteria>
- Workout lifecycle behavior is locked in by passing characterization tests
- DWSMTestHarness and WorkoutStateFixtures are built and reusable
- TEST-01 (workout lifecycle) and TEST-03 (test fixtures) requirements are satisfied
- TEST-04 (commonTest/KMP-compatible) is satisfied -- no platform-specific deps
</success_criteria>

<output>
After completion, create `.planning/phases/01-characterization-tests/01-01-SUMMARY.md`
</output>
